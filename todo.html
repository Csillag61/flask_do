<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>todo.py</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>todo.py</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>A demo web application in the spirit of <a href="http://addyosmani.github.com/todomvc/">TodoMVC</a> showing how to use <strong>RethinkDB as a backend for Flask applications</strong>.</p>

<p>For details about the complete stack, installation, and running see the <a href="https://github.com/rethinkdb/rethinkdb-example-flask-backbone-todo">README</a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">argparse</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">rethinkdb</span> <span class="kn">import</span> <span class="n">r</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>RethinkDB connection details:</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">RDB_HOST</span> <span class="o">=</span> <span class="s">&#39;192.168.0.7&#39;</span>
<span class="n">RDB_PORT</span> <span class="o">=</span> <span class="mi">38015</span></pre></div>
      </td>
    </tr>
    <tr id='section-Setting_up_the_app_database'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Setting_up_the_app_database">&#182;</a>
        </div>
        <h3>Setting up the app database</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>The app will use a table <code>todos</code> in the <code>todoapp</code> database. 
We&rsquo;ll create these here using <a href="http://www.rethinkdb.com/api/#py:manipulating_databases-db_create"><code>db_create</code></a>
and <a href="http://www.rethinkdb.com/api/#py:manipulating_tables-table_create"><code>table_create</code></a>.    </p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">def</span> <span class="nf">dbSetup</span><span class="p">():</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">RDB_HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">RDB_PORT</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">db_create</span><span class="p">(</span><span class="s">&#39;todoapp&#39;</span><span class="p">))</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="s">&#39;todoapp&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">table_create</span><span class="p">(</span><span class="s">&#39;todos&#39;</span><span class="p">))</span>
        <span class="k">print</span> <span class="s">&#39;Database setup completed. Now run the app without --setup.&#39;</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;App database already exists. Run the app without --setup.&#39;</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>We keep a reference to the <code>todos</code> table as we&rsquo;ll use it everywhere:</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">todo_table</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="s">&#39;todoapp&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">&#39;todos&#39;</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-Managing_connections'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Managing_connections">&#182;</a>
        </div>
        <h3>Managing connections</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>The pattern we&rsquo;re using for managing database connections is to have <strong>a connection per request</strong>. 
We&rsquo;re using Flask&rsquo;s <code>@app.before_request</code> and <code>@app.teardown_request</code> for 
<a href="http://www.rethinkdb.com/api/#py:accessing_rql-connect">opening a database connection</a> and 
<a href="http://www.rethinkdb.com/api/#py:accessing_rql-close">closing it</a> respectively.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nd">@app.before_request</span>
<span class="k">def</span> <span class="nf">before_request</span><span class="p">():</span>
    <span class="n">g</span><span class="o">.</span><span class="n">rdb_conn</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">RDB_HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">RDB_PORT</span><span class="p">)</span>

<span class="nd">@app.teardown_request</span>
<span class="k">def</span> <span class="nf">teardown_request</span><span class="p">(</span><span class="n">exception</span><span class="p">):</span>
    <span class="n">g</span><span class="o">.</span><span class="n">rdb_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div>
      </td>
    </tr>
    <tr id='section-Listing_existing_todos'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Listing_existing_todos">&#182;</a>
        </div>
        <h3>Listing existing todos</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>To retrieve all existing tasks, we are using <a href="http://www.rethinkdb.com/api/#py:selecting_data-table"><code>r.table(&lsquo;todos&rsquo;)</code></a> 
in response to a GET request. <code>table.run()</code> returns a batched iterator that we transform into a <code>list</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/todos&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_todos</span><span class="p">():</span>
    <span class="n">selection</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">todo_table</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">rdb_conn</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-Creating_a_todo'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Creating_a_todo">&#182;</a>
        </div>
        <h3>Creating a todo</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>We will create a new todo in response to a POST request to <code>/todos</code> with a JSON payload 
using <a href="http://www.rethinkdb.com/api/#py:writing_data-insert"><code>table.insert</code></a>.</p>

<p>The <code>insert</code> operation returns a single object specifying the number of successfully created objects and their corresponding IDs: 
<code>{ &ldquo;inserted&rdquo;: 1,  &ldquo;errors&rdquo;: 0,  &ldquo;generated_keys&rdquo;: [&ldquo;773666ac-841a-44dc-97b7-b6f3931e9b9f&rdquo;] }</code></p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/todos&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">new_todo</span><span class="p">():</span>
    <span class="n">inserted</span> <span class="o">=</span> <span class="n">todo_table</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">rdb_conn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">inserted</span><span class="p">[</span><span class="s">&#39;generated_keys&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span></pre></div>
      </td>
    </tr>
    <tr id='section-Retrieving_a_single_todo'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Retrieving_a_single_todo">&#182;</a>
        </div>
        <h3>Retrieving a single todo</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>When creating a new task, each gets assigned an unique ID. Then we could retrieve a specific task by GETing <code>/todos/&lt;todo_id&gt;</code>. 
For accessing a single row by its id we use <a href="http://www.rethinkdb.com/api/#py:selecting_data-get"><code>table.get</code></a>.</p>

<p>Using a task&rsquo;s ID will prove more useful when updating, marking as complete, or deleting it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/todos/&lt;string:todo_id&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_todo</span><span class="p">(</span><span class="n">todo_id</span><span class="p">):</span>
    <span class="n">todo</span> <span class="o">=</span> <span class="n">todo_table</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">todo_id</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">rdb_conn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">todo</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-Editing/Updating_a_task'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Editing/Updating_a_task">&#182;</a>
        </div>
        <h3>Editing/Updating a task</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>Updating a todo (editing it or marking it as completed) is performed on a <code>PUT</code> request. 
To save the updated todo we&rsquo;ll do a <a href="http://www.rethinkdb.com/api/#py:writing_data-replace"><code>replace</code></a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/todos/&lt;string:todo_id&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;PUT&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">update_todo</span><span class="p">(</span><span class="n">todo_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">todo_table</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">todo_id</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">rdb_conn</span><span class="p">))</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>If you&rsquo;d like the update operation to happen as the result of a <code>PATCH</code> request (carrying only the updated fields), 
you can use instead <a href="http://www.rethinkdb.com/api/#py:writing_data-update"><code>update</code></a> 
which will merge the database stored JSON object with the new one.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/todos/&lt;string:todo_id&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;PATCH&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">patch_todo</span><span class="p">(</span><span class="n">todo_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">todo_table</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">todo_id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">rdb_conn</span><span class="p">))</span></pre></div>
      </td>
    </tr>
    <tr id='section-Deleting_a_task'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Deleting_a_task">&#182;</a>
        </div>
        <h3>Deleting a task</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>For deleting a todo we&rsquo;ll trigger a database <a href="http://www.rethinkdb.com/api/#py:writing_data-delete"><code>delete</code></a> 
on a <code>DELETE /todos/&lt;todo_id&gt;</code> request.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/todos/&lt;string:todo_id&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">delete_todo</span><span class="p">(</span><span class="n">todo_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">todo_table</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">todo_id</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">rdb_conn</span><span class="p">))</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show_todos</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;todo.html&#39;</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">&#39;Run the Flask todo app&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--setup&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;run_setup&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">run_setup</span><span class="p">:</span>
        <span class="n">dbSetup</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-Best_practices'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Best_practices">&#182;</a>
        </div>
        <h3>Best practices</h3>

<h4>Managing connections: a connection per request</h4>

<p>The RethinkDB server doesn&rsquo;t use a thread-per-connnection approach so opening connections per request will not slow down your database.</p>

<h4>Fetching multiple rows: batched iterators</h4>

<p>When fetching multiple rows from a table, RethinkDB returns a batched iterator containing initially a subset of the complete result. 
Once the end of the current batch is reached, a new batch is retrieved from the server. From a coding point of view this is transparent:</p>

<pre><code>for result in r.table(&lsquo;todos&rsquo;).run(g.rdb_conn):
    print result
</code></pre>

<h4><code>replace</code> vs <code>update</code></h4>

<p>Both <code>replace</code> and <code>update</code> operations can be used to modify one or multiple rows. Their behavior is different: </p>

<ul>
<li>  <code>replace</code> will completely replace the existing rows with new values</li>
<li>  <code>update</code> will merge existing rows with the new values</li>
</ul>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>Licensed under the MIT license: <a href="http://opensource.org/licenses/mit-license.php">http://opensource.org/licenses/mit-license.php</a></p>

<p>Copyright &copy; 2012 RethinkDB</p>

      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
